<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>註冊/登入</title>
</head>
<link rel="stylesheet" href="/urlDemo.css">
<script src="/jquery.min.js"></script>
<script>
    const BASE = 'http://localhost:8080/api/';

    function show(res) {
        const {
            name = undefined,
            message = undefined,
            stack = undefined,
            status = undefined,
            detail = undefined,
            path = undefined,
            timestamp = undefined,
        } = res;
        let safeStack = undefined;
        if (stack != undefined) {
            safeStack = stack.replace(/\n/g, '<br>');
        }
        const err = {
            name,
            message,
            safeStack,
            status,
            detail,
            path,
            timestamp,
        }
        document.getElementById('result').innerHTML = JSON.stringify(err, null, 2);
    }

    // POST JSON helper
    async function postJSON(url, data) {
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if (!res.ok) throw json;
            return json;
        } catch (err) {
            return Promise.reject(err);
        }
    }

    // GET helper with query params
    async function getJSON(url, params) {
        const query = params ? '?' + new URLSearchParams(params) : '';
        try {
            const res = await fetch(url + query, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            const json = await res.json();
            if (!res.ok) throw json;
            return json;
        } catch (err) {
            return Promise.reject(err);
        }
    }
    
    // PUT JSON helper
    async function putJSON(url, data) {
        try {
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if (!res.ok) throw json;
            return json;
        } catch (err) {
            return Promise.reject(err);
        }
    }

    // DELETE JSON helper
    async function deleteJSON(url, data) {
        try {
            const res = await fetch(url, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if (!res.ok) throw json;
            return json;
        } catch (err) {
            return Promise.reject(err);
        }
    }

    // 將值塞入 input 並自動調整寬度
    function setInputValue(inputId, value) {
        const input = document.getElementById(inputId);
        input.value = value;
        if (value.length > 22) {
            input.style.width = (value.length + 1) + "ch";
        } else {
            input.removeAttribute('style');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {

        // 註冊
        document.getElementById('btnRegister').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('regUser').value,
                password: document.getElementById('regPass').value
            };
            try {
                const res = await postJSON(BASE + 'auth/register', data);
                show(res);
                setInputValue('loginUser', data.username);
                setInputValue('loginPass', data.password);
            } catch (err) {
                show(err);
            }
        });

        // 登入
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('loginUser').value,
                password: document.getElementById('loginPass').value
            };
            try {
                const res = await getJSON(BASE + 'auth/login', data);
                show(res);
                if (res.message && res.message.token) {
                    setInputValue('token', res.message.token);
                }
            } catch (err) {
                show(err);
            }
        });

        // 更改密碼
        document.getElementById('btnUpdatePassword').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('loginUser').value,
                password: document.getElementById('loginPass').value
            };
            try {
                const res = await putJSON(BASE + 'auth/updatePassword', data);
                show(res);
                if (res.message && res.message.token) {
                    setInputValue('token', res.message.token);
                }
            } catch (err) {
                show(err);
            }
        });

        // 驗證 Token
        document.getElementById('btnValidate').addEventListener('click', async () => {
            const token = document.getElementById('token').value;
            try {
                const res = await getJSON(BASE + 'auth/validate', { token });
                show(res);
            } catch (err) {
                show(err);
            }
        });

        // 查詢 Token
        document.getElementById('btnQuery').addEventListener('click', async () => {
            const data = {
                username: document.getElementById('queryUser').value,
                password: document.getElementById('queryPass').value
            };
            try {
                const res = await postJSON(BASE + 'auth/query', data);
                show(res);
                if (res.message && res.message.token) {
                    setInputValue('tokenLogout', res.message.token);
                }
            } catch (err) {
                show(err);
            }
        });

        // 登出
        document.getElementById('btnLogout').addEventListener('click', async () => {
            const token = document.getElementById('tokenLogout').value;
            try {
                const res = await deleteJSON(BASE + 'auth/logout', { token });
                show(res);
            } catch (err) {
                show(err);
            }
        });

        document.getElementById('token').addEventListener('blur', function () {
            setInputValue('token', this.value);
        });

        document.getElementById('tokenLogout').addEventListener('blur', function () {
            setInputValue('tokenLogout', this.value);
        });


    });

</script>

<body>
    <div class="form">
        <h2>註冊</h2>
        <input id="regUser" placeholder="帳號">
        <input id="regPass" placeholder="密碼">
        <button id="btnRegister">註冊</button>
        <h2>登入</h2>
        <input id="loginUser" placeholder="帳號">
        <input id="loginPass" placeholder="密碼">
        <button id="btnLogin">登入</button>
        <button id="btnUpdatePassword">更改密碼</button>
        <h2>驗證 Token</h2>
        <input id="token" placeholder="Token">
        <button id="btnValidate">驗證</button>
    </div>
    <div class="form">
        <h2>查詢 Token</h2>
        <input id="queryUser" placeholder="帳號">
        <input id="queryPass" placeholder="密碼">
        <button id="btnQuery">查詢</button>
        <h2>登出 Token</h2>
        <input id="tokenLogout" placeholder="Token">
        <button id="btnLogout">登出</button>
    </div>
    <section>
        <h3>API Result</h3>
        <pre id="result"></pre>
    </section>
</body>

</html>